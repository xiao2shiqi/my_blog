## 类文件结构

计算机只认识 1 和 0 ，那为什么还会有字节码的存在 ？

1. 用户编写的代码被 `javac` 翻译为统一的字节码 `class` 文件
2. 不同版本的 JVM 将字节码 `class` 文件根据不同的平台，翻译为 1 和 0 的机器码文件，**从而实现跨平台**

答案：**因为字节码是和机器指令集，系统平台无关的存储格式**，所以通过不同平台的虚拟机来执行字节码，从而保证程序执行有相同的结果。



平台无关性的基石：

1. Java 刚诞生的著名口号：Write Once，Run Anywhere 就是通过 JVM 虚拟机来实现的
2. 虚拟机不仅支持 Java，目前运行在 JVM 的语言有：Kotlin，Groovy，JRuby，Scala  等
3. JVM 实现语言和平台无关性的基石就是：虚拟机和字节码的存储格式
4. 只要能把源代码编译微 Class 文件，虚拟机丝毫不关心 Class 的来源是什么语言
5. 字节码指令提供的语言描述能力比 Java 语言本身更加强大，也让其他语言有更大的发挥空间



虚拟机执行程序的过程，如图：

<img src="https://pcloud-1258173945.cos.ap-guangzhou.myqcloud.com/uPic/image-20220303143226678.png" alt="image-20220303143226678" style="zoom:33%;" />



### Class 文件结构

关键信息：

1. 类文件格式的学习过程会非常枯燥，但是要深入虚拟机，这部分是无法回避的
2. Java 技术能保持良好的向后兼容，稳定的 Class 文件结构发挥了关键作用
3. 1997 年定义的 Class 文件结构至今只是新增、扩充内容，并且对已定义的内容做出修改



#### 魔数和 Class 文件的版本

关于魔数：

1. Class 文件的头 4 个字节被称为魔数（Magic Number），作用是确认是否能被虚拟机接受的 Class 的文件
2. 许多文件格式都是用魔数来进行身份标识，相比文件扩展名更安全而且可以自由的选择魔数值
3. Class 文件的魔数值为 0xCAFEBABE，出自早期小组成员喜欢的咖啡品牌，也象征以后 Java 的出现



关于版本号：

1. 魔数后的 4 个字节存储是 Class 文件的版本号
2. 5、6 号字节是次版本号，7、8 号字节是主版本号
3. 高版本 JDK 可以向下兼容执行低版本的 Class 文件，但是不能运行以后版本的 Class 文件
4. 虚拟机拒绝执行超过其版本号的 Class 文件



Class 的文件结构如图：

<img src="https://pcloud-1258173945.cos.ap-guangzhou.myqcloud.com/uPic/image-20220303154257798.png" alt="image-20220303154257798" style="zoom: 50%;" />



#### 常量池

1. 主、次版本号之后就是常量池入口，通常数量不固定，所以在入口放置 u2 类型数据代表常量池容器计数值
2. 常量池容量为 22 就代表池中有 21 项常量，常量池比较特殊计数是从 1 开始的
3. 常量池中存放两大类常量：字面量 Literal、符号饮用 Symbolic References。接近 Java 语言的常量概念
4. 最初有 11 种结构，为了更好支持动态语言增加 4 种常量，为了支持 Java 11 模块化又增加 2 种常量
4. JDK 的 bin 目录提供专门用于分析 Class 文件字节码的工具：`javap` ，使用方法参考下文



索引范围 1～22 的常量池结构：

<img src="https://pcloud-1258173945.cos.ap-guangzhou.myqcloud.com/uPic/image-20220303161520158.png" alt="image-20220303161520158" style="zoom:33%;" />



javap 命令的简单用法，如下：

```sh
$ javap -verbose JConsoleDemo.class
Classfile /Users/xiaobin/Documents/IdeaWorkSpace/JVM_Demo/out/production/JVM_Demo/JConsoleDemo.class
  Last modified Mar 1, 2022; size 1055 bytes
  MD5 checksum 45e2200aef376ca4591855cca074eeb2
  Compiled from "JConsoleDemo.java"
public class JConsoleDemo
  minor version: 0
  major version: 52
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
  this_class: #12                         // JConsoleDemo
  super_class: #13                        // java/lang/Object
  interfaces: 0, fields: 0, methods: 3, attributes: 2
Constant pool:
# ..... 这里省略
```



#### 访问标志

1. 接着常量池后面的 2 个字节代表访问标志 access_flags，识别类、接口的访问信息
2. 包含信息：类、抽象类和接口的信息，访问权限的信息，还有 final 等等信息



访问标志符号的含义如下：

<img src="https://pcloud-1258173945.cos.ap-guangzhou.myqcloud.com/uPic/image-20220303164158482.png" alt="image-20220303164158482" style="zoom: 50%;" />

access_flags 在 Class 文件中的显示，如下：

<img src="https://pcloud-1258173945.cos.ap-guangzhou.myqcloud.com/uPic/image-20220303164307731.png" alt="image-20220303164307731" style="zoom: 50%;" />



#### 类索引和接口索引

1. Class 的继承关系由：类索引 this_class，父类索引 super_class，接口索引集合 interfaces 这三项数据来确定
2. Java 语言不允许多继承，除了 java.lang.Object 以外，父类索引只有一个，且父类索引都不为 0
3. 接口索引集合描述类实现了哪些接口，接口按照 implements 从左到右的顺序排列



#### 字段表集合

1. 字段表 field_info 用于描述类中声明的变量，但不包括方法内部的局部变量